use std::{fmt::Debug, iter::once, ops::Range};

use bit_vec::BitVec;
use glam::UVec2;
use itertools::Itertools;

const SAND_SRC: UVec2 = UVec2::new(500, 0);

#[macro_rules_attribute::apply(challenge)]
#[aoc(2022, 14, 1)]
fn run(inp: &str) -> usize {
    let mut ras = Raster::parse(inp);
    for i in 0.. {
        if ras.drop_sand() {
            return i;
        }
    }
    unreachable!()
}

struct Raster {
    yrange: Range<usize>,
    xrange: Range<usize>,
    grid: BitVec,
}

impl Debug for Raster {
    fn fmt(&self, f: &mut std::fmt::Formatter<'_>) -> std::fmt::Result {
        for y in self.yrange.clone() {
            for x in self.xrange.clone() {
                write!(f, "{}", if self.get(x, y).unwrap() { '#' } else { '.' })?;
            }
            writeln!(f)?;
        }
        writeln!(f)
    }
}

impl Raster {
    fn parse(inp: &str) -> Self {
        let mut ymax = 0usize;
        let mut xmin = usize::max_value();
        let mut xmax = 0usize;
        for p in lines(inp).flatten() {
            xmax = xmax.max(p.x as usize);
            xmin = xmin.min(p.x as usize);
            ymax = ymax.max(p.y as usize);
        }
        let mut ret = Raster {
            yrange: 0..(ymax + 1),
            xrange: xmin..(xmax + 1),
            grid: BitVec::from_fn((ymax + 1) * (xmax - xmin + 1), |_| false),
        };
        for pixel in lines(inp).flat_map(draw_line) {
            ret.set(pixel.x as usize, pixel.y as usize, true);
        }
        ret
    }

    fn get(&self, x: usize, y: usize) -> Option<bool> {
        Some(self.grid.get(self.idx(x, y)?).unwrap())
    }

    fn set(&mut self, x: usize, y: usize, v: bool) -> Option<()> {
        self.grid.set(self.idx(x, y)?, v);
        Some(())
    }

    fn idx(&self, x: usize, y: usize) -> Option<usize> {
        if !self.xrange.contains(&x) || !self.yrange.contains(&y) {
            return None;
        }
        let x = x - self.xrange.start;
        let y = y - self.yrange.start;
        Some(x + y * self.xrange.len())
    }

    fn drop_sand(&mut self) -> bool {
        let mut sandx = SAND_SRC.x as usize;
        let mut sandy = SAND_SRC.y as usize;
        loop {
            // have we entered the abyss?
            if !self.xrange.contains(&sandx) || !self.yrange.contains(&sandy) {
                return true;
            }
            if sandx <= self.xrange.start {
                // any sand on the far left will eventually fall
                // this also guards against integer underflow
                return true;
            }

            if !self.get(sandx, sandy + 1).unwrap_or(false) {
                sandy += 1;
                continue;
            }
            if !self.get(sandx - 1, sandy + 1).unwrap_or(false) {
                sandy += 1;
                sandx -= 1;
                continue;
            }
            if !self.get(sandx + 1, sandy + 1).unwrap_or(false) {
                sandy += 1;
                sandx += 1;
                continue;
            }
            self.set(sandx, sandy, true);
            return false;
        }
    }
}

/// returns an iterator over the discrete locations the line touches
fn draw_line([mut a, mut b]: [UVec2; 2]) -> impl Iterator<Item = UVec2> {
    assert!(a.x == b.x || a.y == b.y, "aint nobody got time for that");
    if (a.x, a.y) > (b.x, b.y) {
        std::mem::swap(&mut a, &mut b);
    }
    let start = once(a.clone());
    let rest = (0..).map_while(move |_| {
        if a == b {
            return None;
        }
        a.x = (a.x + 1).min(b.x);
        a.y = (a.y + 1).min(b.y);
        Some(a)
    });
    start.chain(rest)
}

fn lines(inp: &'_ str) -> impl Iterator<Item = [UVec2; 2]> + '_ {
    inp.lines()
        .flat_map(|line| trace(line).zip(trace(line).skip(1)))
        .map(|(a, b)| [a, b])
}

fn trace(line: &'_ str) -> impl Iterator<Item = UVec2> + '_ {
    line.split(" -> ").map(|point| {
        let (a, b) = point
            .split(",")
            .map(|n| n.parse().unwrap())
            .collect_tuple()
            .unwrap();
        UVec2::new(a, b)
    })
}

#[cfg(test)]
mod test {
    use super::*;

    #[test]
    fn test() {
        let inp = "498,4 -> 498,6 -> 496,6
503,4 -> 502,4 -> 502,9 -> 494,9";
        assert_eq!(run(inp), 24);
    }

    #[test]
    fn test2() {
        let inp = "498,4 -> 498,6 -> 496,6
503,4 -> 502,4 -> 502,9 -> 494,9";
        let got = lines(inp).collect_vec();
        let expected: Vec<[UVec2; 2]> = vec![
            [UVec2::new(498, 4), UVec2::new(498, 6)],
            [UVec2::new(498, 6), UVec2::new(496, 6)],
            [UVec2::new(503, 4), UVec2::new(502, 4)],
            [UVec2::new(502, 4), UVec2::new(502, 9)],
            [UVec2::new(502, 9), UVec2::new(494, 9)],
        ];
        assert_eq!(got, expected);
    }
}

const _CAVE: &str = r#"
..............................................................
..............................................................
..............................................................
..............................................................
..............................................................
..............................................................
..............................................................
..............................................................
..............................................................
........................................#.....................
.......................................###....................
......................................#####...................
.....................................#######..................
....................................#########.................
...................................#.....#####................
..................................###...#######...............
.................................#####.##########.............
................................#################.............
................................#################.............
................................#################.............
................................#################.............
................................#################.............
................................#################.............
................................#################.............
................................#################.#...........
................................#################.#...........
................................###################...........
...............................#..............................
..............................###.............................
.............................#####............................
............................#######...........................
............................#######...........................
...........................########...........................
..........................#########...........................
.........................##########...........................
........................###########...........................
.......................############.#.........................
......................#############.#.........................
.....................##############.#.........................
....................#################.........................
...................######.....................................
..................########....................................
.................##########...................................
................#####....###..................................
...............########.######................................
..............####............................................
.............#######.######.######............................
............###...............................................
...........#####..............................................
..........#######.............................................
..........#######.............................................
..........#######.............................................
.........########.............................................
........##########............................................
........#.########............................................
........##########............................................
........##########............................................
........##########............................................
........##########............................................
........##########............................................
........##########............................................
..............................................................
..............................................................
......##......................................................
.....####.....................................................
....######....................................................
....#######...................................................
....########..................................................
....#########.................................................
..#.#########.................................................
#.#.#########.................................................
#.#.#########.................................................
#.#.##########................................................
###############...............................................
............####..............................................
...........######.............................................
..........########............................................
..........#########...........................................
..........##########..........................................
..........###########.........................................
......################........................................
......#...#####......#........................................
......#..#######.....#........................................
......#.#########....#........................................
......################........................................
..............................................................
..............................................................
.....................##.......................................
...............#....####......................................
...............#########......................................
..............................................................
.......................##.....................................
.....................#####....................................
.....................#####....................................
.....................#####....................................
.....................######...................................
................############..................................
................#....#####.#..................................
................#...########..................................
................############..................................
..............................................................
..............................................................
.........................#....................................
.........................#....................................
.........................#.##.................................
.........................#####................................
.........................#####................................
.........................#####................................
.........................#####................................
.........................#####................................
.........................#####................................
.........................#####................................
.........................######...............................
.............................###..............................
............................#####.............................
...........................#######............................
..........................########............................
.........................#########............................
........................##########............................
.....................##############...........................
.....................#.......######...........................
.....................#......#######...........................
.....................#.....########...........................
.....................#....##########..........................
.....................#...############.........................
.....................#..##############........................
.....................##################.......................
..................................######......................
.................................########.....................
................................##########....................
...............................############...................
..............................#############...................
.............................###..............................
............................#####.............................
....................#......#######......#.....................
....................#####################..#..................
..........................................###.................
.........................................#####................
........................................#######...............
.......................................#.....###..............
......................................###...#####.............
.....................................#############............
....................................#.....###.................
...................................###...#####................
..................................#############.######........
.................................#.....###....................
................................###...#####...................
...............................#############.######.######....
..............................#.....###.......................
.............................###...#####......................
............................#############.######.######.######
.................................###..........................
................................#####.........................
...........................#...#######........................
..........................###.###...###.......................
.........................#########.#####......................
........................######................................
.......................########.#####.#####...................
......................#####...................................
.....................#######..................................
....................#########.................................
...................#####...###................................
..................#######.#####...............................
.................####.........................................
................######.#####.#####............................
...............###............................................
..............#####.#####.#####.#####.........................
"#;

const _SETUP: &str = r#"
..............................................................
..............................................................
..............................................................
..............................................................
..............................................................
..............................................................
..............................................................
..............................................................
..............................................................
..............................................................
..............................................................
..............................................................
..............................................................
....................................######....................
..............................................................
..............................................................
..................................#.............#.............
................................#.#...#.........#.............
................................#.#...#.........#.............
................................#.#...#.........#.............
................................#.#...#.#.......#.............
................................#.#...#.#.....#.#.............
................................#.#.#.#.#.....#.#.............
................................#.#.#.#.#...#.#.#.............
................................#.#.#.#.#...#.#.#.#...........
................................#.#.#.#.#.#.#.#.#.#...........
................................###################...........
..............................................................
..............................................................
..............................................................
............................#.....#...........................
............................#.....#...........................
............................#.....#...........................
..........................#.#.....#...........................
..........................#.#.....#...........................
..........................#.#.#...#...........................
..........................#.#.#...#.#.........................
..........................#.#.#...#.#.........................
........................#.#.#.#.#.#.#.........................
........................#############.........................
..............................................................
..............................................................
....................######....................................
..............................................................
.................######.######................................
..............................................................
..............######.######.######............................
..............................................................
..............................................................
..........#.....#.............................................
..........#.....#.............................................
..........#.....#.............................................
..........#.....#.............................................
........###.....##............................................
........#........#............................................
........#........#............................................
........#........#............................................
........#........#............................................
........#........#............................................
........#........#............................................
........##########............................................
..............................................................
..............................................................
..............................................................
........#.....................................................
....#.#.#.....................................................
....#.#.#.....................................................
....#.#.#.....................................................
....#.#.#.#.#.................................................
..#.#.#.#.#.#.................................................
#.#.#.#.#.#.#.................................................
#.#.#.#.#.#.#.................................................
#.#.#.#.#.#.#.................................................
#############.................................................
..............................................................
..............................................................
..........#...#...............................................
..........#...#...............................................
..........#...#...............................................
..........#...#...............................................
......#####...########........................................
......#..............#........................................
......#..............#........................................
......#..............#........................................
......################........................................
..............................................................
..............................................................
..............................................................
...............#.......#......................................
...............#########......................................
..............................................................
..............................................................
.....................#...#....................................
.....................#...#....................................
.....................#...#....................................
.....................#...#....................................
................######...###..................................
................#..........#..................................
................#..........#..................................
................############..................................
..............................................................
..............................................................
.........................#....................................
.........................#....................................
.........................#....................................
.........................#...#................................
.........................#...#................................
.........................#...#................................
.........................#...#................................
.........................#...#................................
.........................#...#................................
.........................#.#.#................................
.........................#####................................
..............................................................
..............................................................
.............................#...#............................
.............................#...#............................
.............................#...#............................
.............................#...#............................
.....................#########...##...........................
.....................#............#...........................
.....................#............#...........................
.....................#............#...........................
.....................#............#...........................
.....................#............#...........................
.....................#............#...........................
.....................##############...........................
..............................................................
..............................................................
..............................................................
..........................................#...................
...............................############...................
..............................................................
..............................................................
....................#...................#.....................
....................#####################.....................
..............................................................
..............................................................
........................................######................
..............................................................
..............................................................
.....................................######.######............
..............................................................
..............................................................
..................................######.######.######........
..............................................................
..............................................................
...............................######.######.######.######....
..............................................................
..............................................................
............................######.######.######.######.######
..............................................................
..............................................................
................................#####.........................
..............................................................
.............................#####.#####......................
..............................................................
..........................#####.#####.#####...................
..............................................................
..............................................................
.......................#####..................................
..............................................................
....................#####.#####...............................
..............................................................
.................#####.#####.#####............................
..............................................................
..............#####.#####.#####.#####.........................
"#;
